<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASIå¹³å°ä¸“ç”¨AIåŠ©æ‰‹ (æœ€ç»ˆä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Add SheetJS library for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
        }
        .prose-custom {
            color: #334155;
            line-height: 1.7;
        }
        .prose-custom h3 {
            color: #1e293b;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
         .prose-custom h4 {
            color: #1e293b;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .prose-custom .content-block {
            white-space: pre-line;
            word-wrap: break-word;
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        .mini-loader-inline {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .history-item {
            transition: background-color 0.2s;
        }
        .history-item:hover {
            background-color: #f1f5f9;
        }
        .validation-msg {
            font-size: 0.8rem;
            font-weight: 500;
        }
        .input-group-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            line-height: 1rem;
            background-color: #eef2ff;
            color: #4338ca;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
        }
        .action-btn:hover {
            background-color: #e0e7ff;
        }
        .action-btn:disabled {
            background-color: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Lock feature styles */
        .section-wrapper.locked {
            background-color: #f0f5ff; /* A light blue to indicate locked */
            border-radius: 0.5rem;
            padding: 2px 8px;
            margin: -2px -8px;
        }
    </style>
</head>
<body class="bg-slate-100">
    <header class="text-center py-6 px-4">
        <h1 class="text-3xl md:text-4xl font-bold text-slate-900">ASIå¹³å°ä¸“ç”¨AIåŠ©æ‰‹</h1>
        <p class="mt-2 text-slate-600">ä¸Šä¼ /ç²˜è´´å›¾ç‰‡ã€è¾“å…¥ä¿¡æ¯ä¸å‚è€ƒæ–‡æ¡ˆï¼Œä¸€é”®ç”Ÿæˆã€‚</p>
    </header>

    <main class="lg:grid lg:grid-cols-2 lg:gap-8 p-4">
        <!-- Left Column (Inputs) -->
        <div class="lg:sticky lg:top-4 self-start">
             <div class="bg-white p-6 rounded-2xl shadow-lg relative flex flex-col h-[848px]">
                <!-- NEW: Header for the left panel -->
                <div class="flex justify-between items-center pb-4 border-b mb-4 flex-shrink-0">
                    <h2 class="text-xl font-bold text-slate-800">äº§å“ä¿¡æ¯</h2>
                    <div class="flex items-center gap-3">
                         <button id="clearAllBtn" class="text-sm bg-slate-200 text-slate-600 py-2 px-3 rounded-lg hover:bg-slate-300 transition" title="æ¸…ç©ºæ‰€æœ‰è¾“å…¥å’Œç»“æœ">
                            æ¸…ç©ºå†…å®¹
                        </button>
                        <button id="generateAllBtn" class="text-sm bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                            ä¸€é”®ç”Ÿæˆ
                        </button>
                    </div>
                </div>
                 <div class="flex-grow overflow-y-auto custom-scrollbar pr-3 -mr-3">
                    <!-- Image Upload Section -->
                    <div class="mb-6">
                        <p class="input-group-title">1. ä¸Šä¼ äº§å“å›¾ç‰‡ (æ¨è)</p>
                        <div id="image-preview-container" class="hidden group relative w-48 h-48 mx-auto border-2 border-dashed rounded-lg flex items-center justify-center bg-slate-50">
                            <img id="image-preview" class="max-w-full max-h-full rounded-md">
                            <button id="remove-image-btn" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                        </div>
                         <div id="upload-box" class="mt-2">
                            <label for="imageUpload" class="w-full cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg text-center transition block">
                                ç‚¹å‡»ä¸Šä¼ æˆ–ç›´æ¥ç²˜è´´å›¾ç‰‡
                            </label>
                            <input type="file" id="imageUpload" class="hidden" accept="image/png, image/jpeg, image/webp">
                        </div>
                    </div>

                    <div class="border-t pt-6">
                         <p class="input-group-title">2. è¾“å…¥äº§å“ä¿¡æ¯</p>
                        <div>
                            <label for="productIdea" class="block text-sm font-medium text-slate-700 mb-1">äº§å“åç§°/æ¦‚å¿µ</label>
                            <input type="text" id="productIdea" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="ä¾‹å¦‚ï¼šå¸¦Logoçš„æ—…è¡Œä¿æ¸©æ¯">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="productMaterial" class="block text-sm font-medium text-slate-700 mb-1">äº§å“æè´¨</label>
                                <input type="text" id="productMaterial" class="w-full p-2 border border-slate-300 rounded-lg shadow-sm text-sm" placeholder="ä¾‹å¦‚ï¼š304ä¸é”ˆé’¢, ç«¹ç›–">
                            </div>
                            <div>
                                <label for="productSpecs" class="block text-sm font-medium text-slate-700 mb-1">å°ºå¯¸/è§„æ ¼</label>
                                <input type="text" id="productSpecs" class="w-full p-2 border border-slate-300 rounded-lg shadow-sm text-sm" placeholder="ä¾‹å¦‚ï¼š20oz (600ml), é«˜20cm">
                            </div>
                            <div class="md:col-span-2">
                                <label for="productScenarios" class="block text-sm font-medium text-slate-700 mb-1">æ ¸å¿ƒå–ç‚¹/ä½¿ç”¨åœºæ™¯</label>
                                <textarea id="productScenarios" rows="3" class="w-full p-2 border border-slate-300 rounded-lg shadow-sm text-sm" placeholder="ä¾‹å¦‚ï¼šåŒå±‚çœŸç©ºï¼Œä¿å†·12å°æ—¶ä¿çƒ­6å°æ—¶ã€‚"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label for="referenceText" class="block text-sm font-medium text-slate-700 mb-1">å‚è€ƒæ–‡æ¡ˆ (é€‰å¡«)</label>
                                <textarea id="referenceText" rows="4" class="w-full p-2 border border-slate-300 rounded-lg shadow-sm text-sm" placeholder="è¯·ç²˜è´´å‚è€ƒçš„æ ‡é¢˜ã€æè¿°æˆ–å–ç‚¹..."></textarea>
                            </div>
                             <div class="md:col-span-2">
                                <label for="referenceKeywords" class="block text-sm font-medium text-slate-700 mb-1">å‚è€ƒå…³é”®è¯ (æ¥è‡ªå–å®¶ç²¾çµç­‰, é€‰å¡«)</label>
                                <textarea id="referenceKeywords" rows="4" class="w-full p-2 border border-slate-300 rounded-lg shadow-sm text-sm" placeholder="è¯·ç²˜è´´å…³é”®è¯åˆ—è¡¨ï¼Œç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <!-- Right Column (Outputs) -->
        <div class="mt-8 lg:mt-0 flex flex-col h-[848px] gap-8">
            <!-- History Section -->
            <div id="historySection" class="bg-white p-6 rounded-2xl shadow-lg flex-shrink-0">
                <div id="historyHeader" class="flex justify-between items-center cursor-pointer">
                    <h2 class="text-xl font-bold text-slate-800">å†å²è®°å½•</h2>
                    <div class="flex items-center gap-2">
                        <button id="exportAllBtn" class="text-sm bg-green-100 text-green-700 font-medium py-1 px-3 rounded-lg hover:bg-green-200 transition">æ‰¹é‡å¯¼å‡º</button>
                        <button id="clearHistoryBtn" class="text-sm bg-red-100 text-red-700 font-medium py-1 px-3 rounded-lg hover:bg-red-200 transition">æ¸…ç©ºå†å²</button>
                        <button id="toggleHistoryBtn" class="p-1 rounded-full hover:bg-slate-200 transition">
                            <svg id="history-arrow" class="w-5 h-5 text-slate-600 transition-transform transform -rotate-90" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                    </div>
                </div>
                <ul id="historyList" class="space-y-2 max-h-0 overflow-y-auto mt-0 transition-all duration-500 ease-in-out custom-scrollbar">
                    <!-- History items will be injected here -->
                </ul>
            </div>
            
            <!-- Output Section -->
            <div id="output" class="bg-white p-6 rounded-2xl shadow-lg flex-grow min-h-0 flex flex-col">
                 <div class="overflow-y-auto custom-scrollbar -mr-3 pr-3 h-full">
                    <div id="placeholder" class="text-center text-slate-500 flex flex-col items-center justify-center h-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-slate-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                        <p>AIç”Ÿæˆçš„å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
                    </div>
                    <div id="loader" class="loader hidden"></div>
                    <div id="result" class="prose-custom"></div>
                </div>
            </div>
        </div>
        
         <!-- Message Box -->
        <div id="messageBox" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg hidden fade-in">
            <p id="messageText"></p>
        </div>

        <!-- API Key Modal -->
        <div id="apiKeyModal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-50 px-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md m-4">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">é…ç½® API å¯†é’¥</h2>
                <p id="apiKeyMessage" class="text-slate-600 mb-4">ä¸ºäº†ä½¿ç”¨AIåŠŸèƒ½ï¼Œè¯·è¾“å…¥æ‚¨çš„ Google Gemini API å¯†é’¥ã€‚å¯†é’¥å°†å®‰å…¨åœ°å­˜å‚¨åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­ã€‚</p>
                <div class="mb-6">
                    <label for="apiKeyInput" class="block text-sm font-medium text-slate-700 mb-2">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„å¯†é’¥">
                </div>
                <div class="text-xs text-slate-500 mb-8">
                    ä¸çŸ¥é“å¦‚ä½•è·å–ï¼Ÿ 
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="font-medium text-indigo-600 hover:text-indigo-500">
                        ç‚¹å‡»æ­¤å¤„å‰å¾€ Google AI Studio è·å–
                    </a>
                </div>
                <div class="mt-8 flex justify-end">
                    <button id="saveApiKeyBtn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">ä¿å­˜å¯†é’¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const generateAllBtn = document.getElementById('generateAllBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const outputDiv = document.getElementById('output');
        const placeholder = document.getElementById('placeholder');
        const loader = document.getElementById('loader');
        const resultDiv = document.getElementById('result');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const historyList = document.getElementById('historyList');
        const historyHeader = document.getElementById('historyHeader');
        const historyArrow = document.getElementById('history-arrow');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const exportAllBtn = document.getElementById('exportAllBtn');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const uploadBox = document.getElementById('upload-box');
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const apiKeyMessage = document.getElementById('apiKeyMessage');
        
        // --- Global Variables & Constants ---
        let history = [];
        let uploadedImageBase64 = null;
        let uploadedImageType = null;

        const REGEN_TYPE_MAP = { 
            'title': 'äº§å“åç§°', 
            'description': 'äº§å“æè¿°', 
            'summary': 'æ¦‚è¦', 
            'keywords': 'å…³é”®è¯' 
        };
        
        const ENGLISH_TITLE_MAP = {
            'Title': 'äº§å“åç§°',
            'Description': 'äº§å“æè¿°',
            'Summary': 'æ¦‚è¦',
            'Keywords': 'å…³é”®è¯'
        };

        const REVERSE_ENGLISH_TITLE_MAP = Object.fromEntries(Object.entries(ENGLISH_TITLE_MAP).map(a => a.reverse()));


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initApp);
        generateAllBtn.addEventListener('click', () => handleGeneration('all'));
        clearAllBtn.addEventListener('click', clearAllInputs);
        clearHistoryBtn.addEventListener('click', clearHistory);
        exportAllBtn.addEventListener('click', () => exportToExcel(history));
        historyHeader.addEventListener('click', (e) => {
            if (!e.target.closest('#clearHistoryBtn') && !e.target.closest('#exportAllBtn')) {
                toggleHistory();
            }
        });
        historyList.addEventListener('click', handleHistoryListClick);
        imageUpload.addEventListener('change', handleImageFile);
        removeImageBtn.addEventListener('click', removeImage);
        document.addEventListener('paste', handlePaste);
        resultDiv.addEventListener('click', handleResultClick);
        saveApiKeyBtn.addEventListener('click', saveApiKey);


        // --- App Initialization ---
        function initApp() {
            loadHistory();
            const savedKey = localStorage.getItem('geminiApiKey');
            if (!savedKey) {
                showApiKeyModal('æ¬¢è¿ä½¿ç”¨ï¼è¯·å…ˆé…ç½®æ‚¨çš„APIå¯†é’¥ã€‚');
            }
        }

        // --- API Key Modal Logic ---
        function showApiKeyModal(message) {
            apiKeyMessage.textContent = message || 'ä¸ºäº†ä½¿ç”¨AIåŠŸèƒ½ï¼Œè¯·è¾“å…¥æ‚¨çš„ Google Gemini API å¯†é’¥ã€‚å¯†é’¥å°†å®‰å…¨åœ°å­˜å‚¨åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­ã€‚';
            apiKeyModal.classList.remove('hidden');
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('geminiApiKey', key);
                apiKeyModal.classList.add('hidden');
                showMessage('APIå¯†é’¥å·²ä¿å­˜ï¼', 'success');
            } else {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„APIå¯†é’¥ã€‚', 'error');
            }
        }

        // --- Image Handling ---
        function handleImageFile(event) {
            const file = event.target.files[0];
            if (file) processImageFile(file);
        }
        
        function handlePaste(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    event.preventDefault(); 
                    processImageFile(item.getAsFile());
                    break; 
                }
            }
        }

        function processImageFile(file) {
             if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImageBase64 = e.target.result.split(',')[1];
                uploadedImageType = file.type;
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');
                uploadBox.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            uploadedImageBase64 = null;
            uploadedImageType = null;
            imagePreview.src = '';
            imageUpload.value = '';
            imagePreviewContainer.classList.add('hidden');
            uploadBox.classList.remove('hidden');
        }
        
        // --- Content Handling ---
        function clearAllInputs() {
            removeImage();
            document.getElementById('productIdea').value = '';
            document.getElementById('productMaterial').value = '';
            document.getElementById('productSpecs').value = '';
            document.getElementById('productScenarios').value = '';
            document.getElementById('referenceText').value = '';
            document.getElementById('referenceKeywords').value = '';
            resultDiv.innerHTML = '';
            placeholder.classList.remove('hidden');
            generateAllBtn.innerHTML = 'ä¸€é”®ç”Ÿæˆ'; // Reset button text
            showMessage('æ‰€æœ‰å†…å®¹å·²æ¸…ç©ºã€‚', 'success');
        }
        
        function handleResultClick(event) {
            const regenBtn = event.target.closest('.regenerate-btn');
            const copyBtn = event.target.closest('.copy-btn');
            const translateBtn = event.target.closest('.translate-btn');
            const lockBtn = event.target.closest('.lock-btn');

             if (regenBtn) {
                const type = regenBtn.dataset.type;
                handleSingleRegeneration(type);
            } else if (copyBtn) {
                const contentBlock = copyBtn.closest('.section-wrapper').querySelector('.content-block');
                const textToCopy = getCleanTextFromBlock(contentBlock);
                copyToClipboard(textToCopy);
            } else if (translateBtn) {
                const contentBlock = translateBtn.closest('.section-wrapper').querySelector('.content-block');
                const textToTranslate = getCleanTextFromBlock(contentBlock);
                openGoogleTranslate(textToTranslate);
            } else if (lockBtn) {
                toggleLock(lockBtn);
            }
        }
        
        function getCleanTextFromBlock(contentBlock) {
            if (!contentBlock) return '';
            return contentBlock.childNodes[0] ? contentBlock.childNodes[0].nodeValue.trim() : '';
        }

        function toggleLock(lockBtn) {
            const section = lockBtn.closest('.section-wrapper');
            const isLocked = section.classList.toggle('locked');
            const regenBtn = section.querySelector('.regenerate-btn');
            
            lockBtn.innerHTML = isLocked ? 
                `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2"/></svg><span>é”å®š</span>` :
                `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2"/></svg><span>è§£é”</span>`;
            
            lockBtn.setAttribute('title', isLocked ? 'ç‚¹å‡»è§£é”' : 'ç‚¹å‡»é”å®š');
            if (regenBtn) {
                regenBtn.disabled = isLocked;
            }
        }

        function openGoogleTranslate(text) {
            const encodedText = encodeURIComponent(text);
            const url = `https://translate.google.com/?sl=en&tl=zh-CN&text=${encodedText}&op=translate`;
            window.open(url, '_blank');
        }

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            } catch (err) {
                showMessage('å¤åˆ¶å¤±è´¥ï¼', 'error');
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        }

        // --- Main Generation Handler ---
        async function handleGeneration(type) {
            const productIdea = document.getElementById('productIdea').value.trim();
            if (!productIdea) {
                showMessage('è¯·è¾“å…¥äº§å“åç§°/æ¦‚å¿µã€‚', 'error');
                return;
            }

            const sections = Array.from(resultDiv.querySelectorAll('.section-wrapper'));
            const lockedContent = new Map();
            const unlockedTypes = new Set(['title', 'description', 'summary', 'keywords']);

            sections.forEach(section => {
                if (section.classList.contains('locked')) {
                    const type = section.querySelector('.regenerate-btn')?.dataset.type;
                    if (type) {
                        lockedContent.set(type, section.innerHTML);
                        unlockedTypes.delete(type);
                    }
                }
            });

            if (unlockedTypes.size === 0 && sections.length > 0) {
                showMessage('æ‰€æœ‰æ¨¡å—éƒ½å·²é”å®šï¼Œæ— éœ€ç”Ÿæˆã€‚', 'info');
                return;
            }

            const typesToGenerate = Array.from(unlockedTypes);
            if (typesToGenerate.length === 0) {
                typesToGenerate.push('all');
            }

            const material = document.getElementById('productMaterial').value.trim();
            const specs = document.getElementById('productSpecs').value.trim();
            const scenarios = document.getElementById('productScenarios').value.trim();
            const referenceText = document.getElementById('referenceText').value.trim();
            const referenceKeywords = document.getElementById('referenceKeywords').value.trim();
            const details = { material, specs, scenarios, referenceText, referenceKeywords };
            
            const generationMode = typesToGenerate.length >= 4 ? 'all' : typesToGenerate.join(',');
            const prompt = createPrompt(generationMode, productIdea, details);

            showLoading(true);
            try {
                const text = await callGeminiAPI(prompt, uploadedImageBase64, uploadedImageType);
                
                if (lockedContent.size > 0) {
                    const newResultHtml = parseAndMergeResults(text, lockedContent, productIdea);
                    resultDiv.innerHTML = newResultHtml;
                } else {
                    displayResult(text, 'all', productIdea);
                }
                
                const fullContentForHistory = resultDiv.innerHTML;
                const fullTextContent = convertHtmlToStructuredText(fullContentForHistory);
                await saveToHistory(productIdea, fullTextContent, details, uploadedImageBase64, uploadedImageType);
                
                generateAllBtn.innerHTML = 'ğŸš€ é‡æ–°ç”Ÿæˆ'; // Change button text after successful generation

            } catch (error) {
                console.error('API Call Error:', error);
                const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                displayResult(`æŠ±æ­‰ï¼Œè°ƒç”¨AIæœåŠ¡æ—¶å‡ºé”™ï¼š${errorMessage}`, 'error');
                showMessage(`AIæœåŠ¡è°ƒç”¨å¤±è´¥: ${errorMessage}`, 'error');

                if (errorMessage.includes('401') || errorMessage.includes('APIå¯†é’¥')) {
                    showApiKeyModal('APIå¯†é’¥æ— æ•ˆæˆ–ç¼ºå¤±ï¼Œè¯·æ›´æ–°æˆ–æ·»åŠ å¯†é’¥ã€‚');
                }

            } finally {
                showLoading(false);
            }
        }
        
        // --- Helper to extract clean content from AI's raw response block ---
        function extractCleanContent(rawText) {
             if (!rawText) return '';
             return rawText.replace(/^###\s+(Title|Summary|Description|Keywords)\s*\n---\n?/, '').trim();
        }

        async function handleSingleRegeneration(type) {
            const productIdea = document.getElementById('productIdea').value.trim();
            if (!productIdea) {
                showMessage('æ— æ³•åœ¨æ²¡æœ‰äº§å“æ¦‚å¿µçš„æƒ…å†µä¸‹é‡æ–°ç”Ÿæˆã€‚', 'error');
                return;
            }

            const material = document.getElementById('productMaterial').value.trim();
            const specs = document.getElementById('productSpecs').value.trim();
            const scenarios = document.getElementById('productScenarios').value.trim();
            const referenceText = document.getElementById('referenceText').value.trim();
            const referenceKeywords = document.getElementById('referenceKeywords').value.trim();
            const details = { material, specs, scenarios, referenceText, referenceKeywords };

            const sectionTitle = REGEN_TYPE_MAP[type];
            const sectionWrapper = document.getElementById(`section-${sectionTitle.replace(/\s/g, '-')}`);
            if (!sectionWrapper) return;

            const regenerateButton = sectionWrapper.querySelector('.regenerate-btn');
            
            if (regenerateButton) {
                regenerateButton.innerHTML = `<span class="mini-loader-inline"></span>`;
                regenerateButton.disabled = true;
            }

            const prompt = createPrompt(type, productIdea, details);

            try {
                const rawText = await callGeminiAPI(prompt, uploadedImageBase64, uploadedImageType);
                const newCleanText = extractCleanContent(rawText);

                const contentBlock = sectionWrapper.querySelector('.content-block');
                contentBlock.innerText = newCleanText; // Use innerText to correctly display line breaks
                
                const counterDiv = createCounterDiv(sectionTitle, newCleanText);
                if (counterDiv) contentBlock.appendChild(counterDiv);

                const validationResult = validateContent(sectionTitle, newCleanText);
                const statusSpan = sectionWrapper.querySelector('.validation-status');
                if(statusSpan) {
                     statusSpan.innerHTML = getValidationStatus(validationResult);
                }
                
                await updateHistoryContent(productIdea, sectionTitle, newCleanText);
            } catch (error) {
                 const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                 showMessage(`é‡æ–°ç”Ÿæˆ'${sectionTitle}'å¤±è´¥: ${errorMessage}`, 'error');
                 if (errorMessage.includes('401') || errorMessage.includes('APIå¯†é’¥')) {
                    showApiKeyModal('APIå¯†é’¥æ— æ•ˆæˆ–ç¼ºå¤±ï¼Œè¯·æ›´æ–°æˆ–æ·»åŠ å¯†é’¥ã€‚');
                 }
            } finally {
                 if (regenerateButton) {
                    regenerateButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg><span>é‡æ–°ç”Ÿæˆ</span>`;
                    regenerateButton.disabled = false;
                }
            }
        }
        
        // --- Prompt Creation Engine ---
        function createPrompt(type, product, details) {
            let productDetailsSection = "\n**Product Details (Use these text details to supplement the provided image):**";
            let hasDetails = false;
            if (details.material) { productDetailsSection += `\n- Material: ${details.material}`; hasDetails = true; }
            if (details.specs) { productDetailsSection += `\n- Specifications: ${details.specs}`; hasDetails = true; }
            if (details.scenarios) { productDetailsSection += `\n- Key Selling Points/Scenarios: ${details.scenarios}`; hasDetails = true; }
            if (details.referenceText) {
                productDetailsSection += `\n- **Reference Text (Crucial):** """${details.referenceText}"""`;
                hasDetails = true;
            }
             if (details.referenceKeywords) {
                productDetailsSection += `\n- **Reference Keywords (High Priority):** """${details.referenceKeywords}"""`;
                hasDetails = true;
            }

            const basePrompt = `You are an expert copywriter for the B2B promotional products platform ASI. Your primary role is to act as a market researcher and content generator.\n\n**Step 1: Simulated Web Research.**\nBased on the user's 'Product Concept', you must first perform a simulated web search on popular e-commerce sites (like Amazon.com) and promotional product platforms (like ASI, 4imprint) to gather typical features, materials, specifications, and marketing angles for this type of product. You must use this simulated research as the primary context for your writing, especially if the user has not provided detailed reference text. For example, if the user enters "umbrella", you should imagine searching for "promotional travel umbrella" and "custom logo umbrella" and use the common features you find (e.g., auto-open, fiberglass ribs, SPF 50+ canopy) to enrich your output.\n\n**Step 2: Content Generation.**\nUsing the context from your research AND the specific details provided by the user, generate the required content. User-provided details (like material, specs, reference text) ALWAYS take precedence over your general research.\n\n**User's Input:**\n- Product Concept: ${product}${hasDetails ? productDetailsSection : ''}\n\n**CRUCIAL, UNBREAKABLE RULES:**\n- **ALL OUTPUT MUST BE IN ENGLISH.** Do not include any Chinese characters or any other language in the output.\n- **YOUR RESPONSE MUST START DIRECTLY WITH '### Title'.** Any other starting text, preamble, or conversational filler will cause a system crash.`;
            
            const titleRules = `**Title Rules:**\n1. Generate 5 unique product names. Each on a new line.\n2. Each name MUST be Title Case (first letter of each word capitalized).\n3. Each name MUST be under 60 characters.\n4. A name MUST NOT contain any repeated words.`;
            const summaryRules = `**Summary Rules:**\n1. Generate one concise paragraph summarizing the product's key highlights.\n2. The summary MUST be under 130 characters.`;
            const descriptionRules = `**Description Rules:**\n1. The description MUST be under 800 characters.\n2. It MUST NOT contain any Chinese punctuation. Use only standard English punctuation.\n3. It MUST NOT contain any price-related language (e.g., "$", "price", "cost").\n4. Structure the paragraph around: Material, Function, Usage Scenarios, Advantages, and an assurance statement.`;
            const keywordRules = `**Keywords Rules:**\n1. Generate exactly 30 keyword groups.\n2. Each group MUST be separated by a comma and a space (e.g., "Word One, Word Two").\n3. Each group MUST be Title Case.\n4. Each group MUST be under 30 characters.\n5. Each group MUST be short, ideally 2-3 words. DO NOT create sentences.\n6. Use relevant terms a customer would search for. DO NOT use irrelevant words.\n7. DO NOT repeat phrases already used in the Title, Summary, or Description.\n8. DO NOT stuff or repeat keywords.\n9. DO NOT use plurals, symbols, or abbreviations.\n10. DO NOT use subjective praise (e.g., "Best", "Amazing").\n11. **Crucially, use the "Reference Keywords" as the primary source.** Clean them up to meet all rules above. If the cleaned reference list is not enough, generate more relevant, non-brand keywords to reach 30 groups. Actively identify and exclude any potential brand names or trademarks.`;
            
            const typeRulesMap = { 'title': titleRules, 'description': descriptionRules, 'summary': summaryRules, 'keywords': keywordRules };
            const englishHeaders = { 'title': 'Title', 'description': 'Description', 'summary': 'Summary', 'keywords': 'Keywords'};

            let taskDescription = '';
            let rulesDescription = '';
            const typesToGenerate = type.split(',').filter(t => t && t !== 'all');

            if (type === 'all' || typesToGenerate.length >= 4) {
                 taskDescription = `**Task: Generate all content sections: Title, Description, Summary, and Keywords.**`;
                 rulesDescription = `**Output Structure & Rules:**\nFollow this structure precisely. Do not add any text before "### Title".\n\n### Title\n---\n[5 names, each on a new line]\n\n### Description\n---\n[1 paragraph]\n\n### Summary\n---\n[1 paragraph]\n\n### Keywords\n---\n[30 comma-separated groups]\n\n${titleRules}\n${descriptionRules}\n${summaryRules}\n${keywordRules}`;
            } else {
                taskDescription = `**Task: Generate ONLY the following sections: ${typesToGenerate.map(t => englishHeaders[t]).join(', ')}.**`;
                rulesDescription = `**Output Structure & Rules:**\n` + typesToGenerate.map(t => `### ${englishHeaders[t]}\n---\n[Content for ${englishHeaders[t]}]\n\n${typeRulesMap[t]}`).join('\n\n');
            }

            return `${basePrompt}\n\n${taskDescription}\n\n${rulesDescription}`;
        }
        
        // --- Validation Engine ---
        function validateContent(chineseTitle, text) {
            const results = { isValid: true, messages: [] };
             if (/[ä¸€-é¾ ]/.test(text)) { 
                results.isValid = false; 
                results.messages.push(`åŒ…å«ä¸­æ–‡`); 
            }
            switch (chineseTitle) {
                case 'äº§å“åç§°':
                    break;
                case 'æ¦‚è¦':
                     if (text.length > 130) { results.isValid = false; results.messages.push(`æ¦‚è¦è¶…é•¿ (${text.length}/130)`); }
                    break;
                case 'äº§å“æè¿°':
                    if (text.length > 800) { results.isValid = false; results.messages.push(`æè¿°è¶…é•¿ (${text.length}/800)`); }
                    if (/[ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼š]/.test(text)) { results.isValid = false; results.messages.push(`å«ä¸­æ–‡æ ‡ç‚¹`); }
                    break;
                case 'å…³é”®è¯':
                    const keywords = text.split(',').map(k => k.trim());
                    if (keywords.length < 30) { results.isValid = false; results.messages.push(`ç»„æ•°: ${keywords.length} (åº”ä¸º30)`); }
                    keywords.forEach(kw => { if (kw.length > 30) { results.isValid = false; results.messages.push(`å…³é”®è¯è¶…é•¿ (${kw.length}/30)`); } });
                    break;
            }
            return results;
        }
        
        function getValidationStatus(validationResult) {
            if (!validationResult.isValid) {
                const message = validationResult.messages.join(', ');
                return `<span class="validation-msg text-red-500">(âš ï¸ ${message})</span>`;
            }
            return '<span class="text-green-500">âœ…</span>';
        }

        function createCounterDiv(chineseTitle, content) {
            let countHtml = '';
             switch (chineseTitle) {
                case 'æ¦‚è¦':
                    countHtml = `${content.length} / 130`;
                    break;
                case 'äº§å“æè¿°':
                    countHtml = `${content.length} / 800`;
                    break;
                case 'å…³é”®è¯':
                    const keywordCount = content.split(',').length;
                    countHtml = `${keywordCount} / 30 ç»„`;
                    break;
            }

            if (countHtml) {
                const countDiv = document.createElement('div');
                countDiv.className = 'absolute bottom-2 right-2 text-xs text-slate-400';
                countDiv.textContent = countHtml;
                return countDiv;
            }
            return null;
        }

        // --- History Management ---
        function toggleHistory() {
            const isCollapsed = historyList.classList.contains('max-h-0');
            if (isCollapsed) {
                historyList.classList.remove('max-h-0', 'mt-0');
                historyList.classList.add('max-h-96', 'mt-4'); // A large enough max-height
                historyArrow.classList.add('rotate-180');
            } else {
                historyList.classList.add('max-h-0', 'mt-0');
                historyList.classList.remove('max-h-96', 'mt-4');
                historyArrow.classList.remove('rotate-180');
            }
        }
        
        async function compressImage(src, maxWidth = 200, maxHeight = 200, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = src;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    const [header, base64Data] = dataUrl.split(',');
                    resolve({ base64: base64Data, type: 'image/jpeg' });
                };
                img.onerror = (error) => reject(error);
            });
        }
        
        function loadHistory() {
            try {
                const storedHistory = localStorage.getItem('asiProductHistory');
                if (storedHistory) { history = JSON.parse(storedHistory); renderHistory(); }
            } catch (e) { console.error("Failed to load history:", e); localStorage.removeItem('asiProductHistory'); }
        }

        function renderHistory() {
            historyList.innerHTML = '';
            if(history.length === 0){
                historyList.innerHTML = `<li class="text-slate-400 text-center text-sm p-4">æš‚æ— å†å²è®°å½•</li>`;
                return;
            }
            history.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'history-item flex justify-between items-center p-3 rounded-lg border border-slate-200';
                li.dataset.index = index;
                li.innerHTML = `
                    <span class="truncate cursor-pointer flex-grow history-item-view" title="${item.product}">${item.product}</span>
                    <button class="history-item-export ml-4 text-xs bg-blue-100 text-blue-700 font-medium py-1 px-2 rounded-md hover:bg-blue-200 transition-colors flex-shrink-0" data-index="${index}">å¯¼å‡º</button>
                `;
                historyList.appendChild(li);
            });
        }

        function handleHistoryListClick(event) {
            const target = event.target;
            const viewTarget = target.closest('.history-item-view');
            const exportTarget = target.closest('.history-item-export');

            if (exportTarget) {
                const index = exportTarget.dataset.index;
                const itemToExport = history[index];
                if (itemToExport) {
                    exportToExcel([itemToExport]);
                }
            } else if (viewTarget) {
                 const li = viewTarget.closest('.history-item');
                 const index = li.dataset.index;
                 viewHistoryItem(index);
            }
        }
        
        async function saveToHistory(product, content, details, imageBase64, imageType) {
            const existingIndex = history.findIndex(item => item.product === product);
            if (existingIndex > -1) history.splice(existingIndex, 1);
            
            let compressedImage = { base64: null, type: null };
            if (imageBase64 && imageType) {
                try { compressedImage = await compressImage(`data:${imageType};base64,${imageBase64}`); } catch (e) { console.error("Image compression failed:", e); }
            }

            history.unshift({ product, content, details, imageBase64: compressedImage.base64, imageType: compressedImage.type, originalImageBase64: imageBase64, originalImageType: imageType });

            try {
                if (history.length > 50) history.pop();
                localStorage.setItem('asiProductHistory', JSON.stringify(history));
            } catch (e) { showMessage('å†å²è®°å½•å­˜å‚¨å¤±è´¥ï¼Œå¯èƒ½å·²æ»¡ã€‚', 'error'); history.shift(); }
            renderHistory();
        }
        async function updateHistoryContent(product, chineseTitle, newContent) {
             const existingIndex = history.findIndex(item => item.product === product);
            if (existingIndex > -1) {
                const currentItem = history[existingIndex];
                const englishTitle = REVERSE_ENGLISH_TITLE_MAP[chineseTitle];
                if (!englishTitle) return;

                const regex = new RegExp(`(### ${englishTitle}\\n---)([\\s\\S]*?)(?=\\n###|$)`);
                const updatedContent = currentItem.content.replace(regex, `$1\n${newContent.trim()}\n`);
                history[existingIndex].content = updatedContent;
                try {
                    localStorage.setItem('asiProductHistory', JSON.stringify(history));
                } catch (e) {
                     console.error("Failed to update history in localStorage:", e);
                }
            }
        }
        function viewHistoryItem(index) {
            const item = history[index];
            if (item) {
                clearAllInputs();
                
                document.getElementById('productIdea').value = item.product || '';
                if(item.details){
                    document.getElementById('productMaterial').value = item.details.material || '';
                    document.getElementById('productSpecs').value = item.details.specs || '';
                    document.getElementById('productScenarios').value = item.details.scenarios || '';
                    document.getElementById('referenceText').value = item.details.referenceText || '';
                    document.getElementById('referenceKeywords').value = item.details.referenceKeywords || '';
                }

                const imageB64 = item.originalImageBase64 || item.imageBase64;
                const imageT = item.originalImageType || item.imageType;
                if (imageB64 && imageT) {
                    const dataUrl = `data:${imageT};base64,${imageB64}`;
                    processImageFile(dataURLtoFile(dataUrl, item.product)); 
                }
                
                displayResult(item.content, 'all', item.product);
                generateAllBtn.innerHTML = 'ğŸš€ é‡æ–°ç”Ÿæˆ'; // Set button text when loading from history
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        function clearHistory() {
            if(confirm('æ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')){
                history = [];
                localStorage.removeItem('asiProductHistory');
                renderHistory();
                showMessage('å†å²è®°å½•å·²æ¸…ç©ºã€‚', 'success');
            }
        }
        
        // --- UI Update Functions ---
        function showLoading(isLoading) {
            loader.classList.toggle('hidden', !isLoading);
            if (isLoading) { placeholder.classList.add('hidden'); resultDiv.innerHTML = ''; }
        }
        
        function parseAndMergeResults(newText, lockedContentMap, productIdea) {
            let finalHtml = `<h3>${productIdea}</h3>`;
            const allTypes = ['title', 'description', 'summary', 'keywords'];
            
            const newSections = new Map();
            const startIndex = newText ? newText.indexOf('###') : -1;
            
            if (startIndex !== -1) {
                const cleanText = newText.substring(startIndex);
                const sections = cleanText.split(/### (Title|Summary|Description|Keywords)\n---/g).filter(s => s && s.trim() !== '');
                for (let i = 0; i < sections.length; i += 2) {
                     if (sections[i + 1] === undefined) continue;
                     const englishTitle = sections[i].trim();
                     const regenType = englishTitle.toLowerCase();
                     newSections.set(regenType, sections[i+1].trim());
                }
            }

            allTypes.forEach(regenType => {
                let sectionHtml;
                if (lockedContentMap.has(regenType)) {
                    sectionHtml = lockedContentMap.get(regenType);
                } else {
                    const content = newSections.get(regenType) || 'ç”Ÿæˆå¤±è´¥æˆ–æ— å†…å®¹è¿”å›';
                    const chineseTitle = REGEN_TYPE_MAP[regenType];
                    sectionHtml = buildSectionHtml(chineseTitle, content, true); // isNew = true
                }
                finalHtml += sectionHtml;
            });

            return finalHtml;
        }

        function buildSectionHtml(chineseTitle, content, isNew) {
            const regenType = Object.keys(REGEN_TYPE_MAP).find(key => REGEN_TYPE_MAP[key] === chineseTitle);
            
            const validationResult = validateContent(chineseTitle, content);
            const status = getValidationStatus(validationResult);
            const isLocked = !isNew;

            const lockButton = `<button class="lock-btn action-btn" data-type="${regenType}" title="${isLocked ? 'ç‚¹å‡»è§£é”' : 'ç‚¹å‡»é”å®š'}">${isLocked ? `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2"/></svg><span>é”å®š</span>` : `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2"/></svg><span>è§£é”</span>`}</button>`;
            const translateButton = `<button class="translate-btn action-btn" title="åœ¨è°·æ­Œç¿»è¯‘ä¸­æ‰“å¼€"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286zm1.634-2.736L5.5 1.956h-.043l-.697 2.022z"/><path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.17.302.278.632.365.992.508-.283.92-1.075 1.21-1.96.28-.85.455-1.85.508-2.934h-1.025c-.05.88-.17 1.56-.34 2.11a2.7 2.7 0 0 1-.62 1.087c-.22.252-.494.456-.79.612z"/></svg><span>ç¿»è¯‘</span></button>`;
            const copyButton = `<button class="copy-btn action-btn" title="å¤åˆ¶å†…å®¹"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/><path d="M5.5 1a.5.5 0 0 1 .5.5V2h6v-.5a.5.5 0 0 1 1 0V2A1.5 1.5 0 0 1 11.5 3.5h-7A1.5 1.5 0 0 1 3 2V1.5a.5.5 0 0 1 .5-.5zM5 3.5a.5.5 0 0 0 .5.5h5a.5.5 0 0 0 0-1h-5a.5.5 0 0 0-.5.5"/></svg><span>å¤åˆ¶</span></button>`;
            const regenButton = `<button class="regenerate-btn action-btn" data-type="${regenType}" title="é‡æ–°ç”Ÿæˆæ­¤ç‰ˆå—" ${isLocked ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg><span>é‡æ–°ç”Ÿæˆ</span></button>`;
            const counterDiv = createCounterDiv(chineseTitle, content);

            return `<div class="section-wrapper ${isLocked ? 'locked' : ''}" id="section-${chineseTitle.replace(/\s/g, '-')}">
                        <h4>
                            <span>${chineseTitle}</span>
                            <span class="validation-status">${status}</span>
                            <div class="ml-auto flex items-center gap-2">${lockButton}${translateButton}${copyButton}${regenButton}</div>
                        </h4>
                        <div class="content-block">
                            ${content}
                            ${counterDiv ? counterDiv.outerHTML : ''}
                        </div>
                     </div>`;
        }

        function displayResult(text, type, productIdea = '') {
            placeholder.classList.add('hidden');
            let html = `<h3>${productIdea}</h3>`;
            const startIndex = text ? text.indexOf('###') : -1;
            
            if (type === 'error') {
                html += `<div class="content-block text-red-600">${text}</div>`;
            } else if (startIndex === -1) {
                html += `<h4>AI åŸå§‹å›å¤ (æ ¼å¼é”™è¯¯)</h4><div class="content-block">${text || 'æ— å†…å®¹è¿”å›'}</div>`;
            } else {
                const cleanText = text.substring(startIndex);
                const sections = cleanText.split(/### (Title|Summary|Description|Keywords)\n---/g).filter(s => s && s.trim() !== '');
                
                for (let i = 0; i < sections.length; i += 2) {
                    const englishTitle = sections[i].trim();
                     if (sections[i + 1] === undefined) {
                        console.warn(`Content missing for section: ${englishTitle}`);
                        continue; 
                    }
                    const content = sections[i + 1].trim();
                    const chineseTitle = ENGLISH_TITLE_MAP[englishTitle] || englishTitle;
                    html += buildSectionHtml(chineseTitle, content, true); // isNew = true
                }
            }
            resultDiv.innerHTML = html;
        }
        
        function convertHtmlToStructuredText(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            let structuredText = '';
            const sections = tempDiv.querySelectorAll('.section-wrapper');
            sections.forEach(section => {
                const chineseTitle = section.querySelector('h4 span:first-child').textContent.trim();
                const englishTitle = REVERSE_ENGLISH_TITLE_MAP[chineseTitle] || chineseTitle;
                const content = getCleanTextFromBlock(section.querySelector('.content-block'));
                structuredText += `### ${englishTitle}\n---\n${content}\n\n`;
            });
            return structuredText.trim();
        }

        function showMessage(message, type = 'success') {
            messageText.textContent = message;
            messageBox.className = 'fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg fade-in';
            if (type === 'error') messageBox.classList.add('bg-red-500');
            else if (type === 'info') messageBox.classList.add('bg-blue-500');
            else messageBox.classList.add('bg-green-500');
            
            setTimeout(() => { messageBox.classList.add('hidden'); }, 3000);
        }

        function dataURLtoFile(dataurl, filename) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){ u8arr[n] = bstr.charCodeAt(n); }
            return new File([u8arr], filename, {type:mime});
        }
        
        // --- Excel Export Functions ---
        function parseContentToObject(contentString) {
            const data = {
                'äº§å“åç§°': '', 'äº§å“æè¿°': '', 'æ¦‚è¦': '', 'å…³é”®è¯': '',
            };
            if (!contentString) return data;

            // Use the map to find the correct chinese title
            const sections = contentString.split(/### (Title|Description|Summary|Keywords)\n---/g).filter(s => s && s.trim() !== '');

            for (let i = 0; i < sections.length; i += 2) {
                const englishTitle = sections[i].trim();
                const content = sections[i + 1] ? sections[i+1].trim() : '';
                const chineseTitle = ENGLISH_TITLE_MAP[englishTitle];
                if (chineseTitle) {
                    data[chineseTitle] = content;
                }
            }
            return data;
        }

        function exportToExcel(items) {
            if (!items || items.length === 0) {
                showMessage('æ²¡æœ‰å¯å¯¼å‡ºçš„å†å²è®°å½•ã€‚', 'info');
                return;
            }

            const dataForSheet = items.map(item => {
                const parsedData = parseContentToObject(item.content);
                return {
                    'äº§å“æ¦‚å¿µ': item.product,
                    'äº§å“åç§°': parsedData['äº§å“åç§°'],
                    'äº§å“æè¿°': parsedData['äº§å“æè¿°'],
                    'æ¦‚è¦': parsedData['æ¦‚è¦'],
                    'å…³é”®è¯': parsedData['å…³é”®è¯'],
                };
            });

            const worksheet = XLSX.utils.json_to_sheet(dataForSheet);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ASI Products');

            // Set column widths
            worksheet["!cols"] = [
                { wch: 30 }, // äº§å“æ¦‚å¿µ
                { wch: 50 }, // äº§å“åç§°
                { wch: 80 }, // äº§å“æè¿°
                { wch: 50 }, // æ¦‚è¦
                { wch: 80 }, // å…³é”®è¯
            ];

            XLSX.writeFile(workbook, `ASI_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
            showMessage('å¯¼å‡ºæˆåŠŸï¼', 'success');
        }


        // --- Gemini API Call ---
        async function callGeminiAPI(prompt, base64Data, mimeType) {
            const userApiKey = localStorage.getItem('geminiApiKey');
            if (!userApiKey) {
                throw new Error('APIå¯†é’¥æœªé…ç½®ã€‚');
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${userApiKey}`;
            const userParts = [{ text: prompt }];
            if (base64Data && mimeType) { userParts.unshift({ inlineData: { mimeType: mimeType, data: base64Data } }); }
            const payload = {
                contents: [{ role: "user", parts: userParts }],
                generationConfig: { temperature: 0.6, topP: 1.0, maxOutputTokens: 8192 }
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error('APIå¯†é’¥æ— æ•ˆæˆ–æƒé™ä¸è¶³ (401/403)ã€‚è¯·æ£€æŸ¥æ‚¨çš„å¯†é’¥ã€‚');
                }
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${await response.text()}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];
            
            if (candidate?.content?.parts?.[0]?.text) {
                 if (candidate.finishReason && candidate.finishReason !== 'STOP') {
                    console.warn(`API response may be partial. Reason: ${candidate.finishReason}`);
                 }
                 return candidate.content.parts[0].text.trim();
            }

            if (candidate) {
                switch (candidate.finishReason) {
                    case 'SAFETY':
                        throw new Error("å†…å®¹å¯èƒ½è¿åäº†å®‰å…¨ç­–ç•¥ï¼Œè¯·ä¿®æ”¹è¾“å…¥åé‡è¯•ã€‚");
                    case 'MAX_TOKENS':
                        throw new Error("å†…å®¹ç”Ÿæˆè¶…å‡ºæœ€å¤§é•¿åº¦é™åˆ¶ï¼Œè¯·å°è¯•ç®€åŒ–è¾“å…¥æˆ–å‚è€ƒæ–‡æ¡ˆã€‚");
                    case 'RECITATION':
                        throw new Error("å†…å®¹å› å¼•ç”¨å—ç‰ˆæƒä¿æŠ¤çš„ææ–™è€Œè¢«é˜»æ­¢ã€‚");
                    default:
                        throw new Error(`AIæœªèƒ½ç”Ÿæˆæœ‰æ•ˆå†…å®¹ã€‚åŸå› : ${candidate.finishReason || 'æœªçŸ¥'}`);
                }
            }
            
            throw new Error("AIæœªèƒ½ç”Ÿæˆæœ‰æ•ˆå†…å®¹ï¼ŒAPIæœªè¿”å›ä»»ä½•å€™é€‰ç»“æœã€‚");
        }
    </script>
</body>
</html>
